<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETAX</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
html { scroll-behavior: smooth; }

body {
  font-family:"Poppins",sans-serif;
  margin:20px;
  background:#eef2f7;
}

h1 {
  text-align:center;
  margin-bottom:15px;
  color:#333;
  font-size:24px;
}

.container {
  max-width:1000px;
  margin:auto;
  background:#fff;
  padding:25px;
  border-radius:15px;
  box-shadow:0 6px 15px rgba(0,0,0,.1);
}

/* KPI */
.kpi {
  display:flex;
  gap:20px;
  justify-content:space-around;
  margin-top:20px;
  flex-wrap:wrap;
}

.card {
  flex:1;
  min-width:180px;
  padding:20px;
  border-radius:15px;
  color:#fff;
  text-align:center;
  font-weight:600;
}

.card span {
  display:block;
  margin-top:6px;
  font-size:18px;
}

.initial { background:linear-gradient(135deg,#ffc107,#ffcd39); }
.income  { background:linear-gradient(135deg,#28a745,#60d394); }
.expense { background:linear-gradient(135deg,#dc3545,#ff6f61); }
.balance { background:linear-gradient(135deg,#17a2b8,#4dd0e1); }

/* Table */
table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:14px;
}

th, td {
  border:1px solid #ddd;
  padding:10px;
  white-space:nowrap;
}

th {
  background:#007bff;
  color:#fff;
}

tr:nth-child(even) { background:#f9f9f9; }

/* Status */
.status-lunas {
  background:#28a745;
  color:#fff;
  padding:4px 10px;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
}

.status-belum {
  background:#dc3545;
  color:#fff;
  padding:4px 10px;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
}

/* Toggle button */
.btn-toggle {
  margin-top:10px;
  padding:10px 14px;
  border:none;
  border-radius:10px;
  background:#007bff;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  font-size:14px;
}

/* Loading */
#loadingOverlay {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(255,255,255,.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
  flex-direction:column;
}

.spinner {
  border:6px solid #e0e0e0;
  border-top:6px solid #007bff;
  border-radius:50%;
  width:60px;
  height:60px;
  animation:spin 1s linear infinite;
  margin-bottom:15px;
}

@keyframes spin { to { transform:rotate(360deg); } }

/* üì± RESPONSIVE HP */
@media (max-width:768px) {
  body { margin:10px; }
  h1 { font-size:20px; }
  .container { padding:15px; }

  .kpi {
    flex-direction:column;
    gap:12px;
  }

  .card {
    padding:16px;
    font-size:14px;
  }

  table {
    display:block;
    overflow-x:auto;
    white-space:nowrap;
    border-radius:10px;
  }

  th, td {
    font-size:12px;
    padding:8px;
  }

  thead th {
    position:sticky;
    top:0;
    z-index:2;
  }

  .btn-toggle {
    width:100%;
    font-size:13px;
  }

  .spinner {
    width:45px;
    height:45px;
    border-width:5px;
  }
}
</style>
</head>

<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>‚è≥ Memuat data...</div>
</div>

<h1>üìí CORETAX (Core Recording & Transaction Application)</h1>

<div class="container">

  <div style="background:#e3f2fd;padding:12px;border-radius:10px;
              margin-bottom:15px;font-weight:600;color:#0d47a1;">
    üëÄ Mode Anggota ‚Äî hanya dapat melihat data
  </div>

  <div class="kpi">
    <div class="card initial">Saldo Awal<br><span id="saldoAwal">Rp 0</span></div>
    <div class="card income">Pemasukan<br><span id="totalPemasukan">Rp 0</span></div>
    <div class="card expense">Pengeluaran<br><span id="totalPengeluaran">Rp 0</span></div>
    <div class="card balance">Saldo<br><span id="totalSaldo">Rp 0</span></div>
  </div>

  <!-- Riwayat Transaksi (Toggle) -->
  <h3>üìë Riwayat Transaksi</h3>
  <button id="toggleRiwayat" class="btn-toggle">üëÅ Lihat Riwayat Transaksi</button>

  <div id="riwayatBox" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Nama</th>
          <th>Keterangan</th>
          <th>Debit</th>
          <th>Kredit</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="tabelKas"></tbody>
    </table>
  </div>

  <!-- Status Utang -->
  <h3 style="margin-top:25px;">üí∞ Status Utang Anggota</h3>
  <table>
    <thead>
      <tr>
        <th>Nama</th>
        <th>Sudah Bayar</th>
        <th>Total Kewajiban</th>
        <th>Sisa Utang</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tabelUtang"></tbody>
  </table>

</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyu6jaGpSW9ttJCmFQv1Z0_Rk3geFsNg3wtednUi4ZYPQTFgiXCCtaN3W2rIHVDIbImnA/exec";
const rupiah = n => 'Rp ' + Number(n||0).toLocaleString('id-ID');

function showLoading(show){
  document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
}

async function loadData(){
  showLoading(true);
  try {
    const res = await fetch(scriptURL);
    const data = await res.json();

    document.getElementById("saldoAwal").textContent = rupiah(data.saldoAwal);
    document.getElementById("totalPemasukan").textContent = rupiah(data.pemasukan);
    document.getElementById("totalPengeluaran").textContent = rupiah(data.pengeluaran);
    document.getElementById("totalSaldo").textContent = rupiah(data.saldo);

    const kas = document.getElementById("tabelKas");
    kas.innerHTML = "";
    data.dataKas.forEach(r=>{
      kas.innerHTML += `
        <tr>
          <td>${r.Tanggal||""}</td>
          <td>${r.Nama||""}</td>
          <td>${r.Keterangan||""}</td>
          <td>${rupiah(r.Debit)}</td>
          <td>${rupiah(r.Kredit)}</td>
          <td>${rupiah(r.Saldo)}</td>
        </tr>`;
    });

    const utang = document.getElementById("tabelUtang");
    utang.innerHTML = "";
    data.statistik.forEach(r=>{
      const status = r.utang<=0
        ? '<span class="status-lunas">Lunas</span>'
        : '<span class="status-belum">Belum</span>';
      utang.innerHTML += `
        <tr>
          <td>${r.nama}</td>
          <td>${rupiah(r.totalBayar)}</td>
          <td>${rupiah(data.mingguBerjalan * data.iuranMingguan)}</td>
          <td>${rupiah(r.utang)}</td>
          <td>${status}</td>
        </tr>`;
    });

  } catch(e){
    alert("Gagal memuat data");
  } finally {
    showLoading(false);
  }
}

loadData();

/* Toggle Riwayat */
const btn = document.getElementById("toggleRiwayat");
const box = document.getElementById("riwayatBox");
btn.onclick = () => {
  if (box.style.display === "none") {
    box.style.display = "block";
    btn.textContent = "‚ùå Tutup Riwayat Transaksi";
  } else {
    box.style.display = "none";
    btn.textContent = "üëÅ Lihat Riwayat Transaksi";
  }
};

/* Auto refresh 60 detik */
setInterval(loadData, 60000);
</script>

</body>
</html>

